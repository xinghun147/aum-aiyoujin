<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8"/>
	<title>提金订单列表</title>
	<link rel="stylesheet" type="text/css" th:href="@{/layui/css/layui.css}" media="all" />
	<link rel="stylesheet" type="text/css" th:href="@{/css/news.css}" media="all" />
	<style>
		.news_search .layui-input-block{margin-left:auto;}
		.news_search .layui-form-label{padding:9px 10px;}
		#orderVerify .layui-layer-btn0{
			height:38px;
			line-height: 38px;
			background-color:#009688;
			outline:none;
			border-color:#009688;
			margin:0;
			margin-top:6px;
		}
	</style>
</head>
<body class="childrenBody">
	<blockquote class="layui-elem-quote news_search">
	<form id="searchForm" name="searchForm" class="layui-form" action="/order/physical/orderList.html">
		<input type="hidden" id="pageNum" name="pageNum" th:value="${page.pageNum}"/>
		<div class="layui-form-item">
			<div class="layui-input-block" style="margin-bottom:10px;">
				<label class="layui-form-label">订单编号:</label>
				<div class="layui-input-inline">
					<input type="text" value="" name="code" class="layui-input search_input" th:value="${vo.code}"/>
				</div>
				<label class="layui-form-label">用户:</label>
				<div class="layui-input-inline">
					<input type="text" value="" name="userName" class="layui-input search_input" th:value="${vo.userName}"/>
				</div>
				<label class="layui-form-label">产品名称:</label>
				<div class="layui-input-inline">
					<input type="text" value="" name="productName" class="layui-input search_input" th:value="${vo.productName}"/>
				</div>
			</div>
			<div class="layui-input-block">
				<label class="layui-form-label">产品状态:</label>
				<div class="layui-input-inline">
					<select name="status" id="status" lay-filter="statusFilter">
						<option value="">请选择查询订单状态</option>
						<option value="0" th:selected="${vo.status == 0}">待审核</option>
						<option value="1" th:selected="${vo.status == 1}">付款成功</option>
						<option value="2" th:selected="${vo.status == 2}">付款失败</option>
						<option value="3" th:selected="${vo.status == 3}">已发货</option>
						<option value="4" th:selected="${vo.status == 4}">已签收</option>
					</select>
				</div>
				<label class="layui-form-label">创建时间:</label>
				<div class="layui-input-inline">
					<input  type="text" class="layui-input" name="createTime" id="startTime" th:value="${vo.createTime}?${#dates.format(vo.createTime, 'yyyy-MM-dd HH:mm:ss')}" readonly="readonly"/>
				</div>
				<div class="layui-form-mid">-</div>
				<div class="layui-input-inline">
					<input  type="text" class="layui-input" name="updateTime" id="endTime"  th:value="${vo.updateTime}?${#dates.format(vo.updateTime, 'yyyy-MM-dd HH:mm:ss')}" readonly="readonly"/>
				</div>
				<button class="layui-btn search_btn"><i class="layui-icon">&#xe615;</i>查询</button>
                <a class="layui-btn excel_btn"><i class="layui-icon">&#xe615;</i>导出</a>
			</div>
		</div>
	</form>
	</blockquote>
	<div class="layui-form news_list">
	  	<table class="layui-table">
		    <colgroup>
				<col/>
				<col/>
				<col/>
				<col/>
		    </colgroup>
		    <thead>
				<tr>
					<th>订单编号</th>
					<th>用户</th>
					<th>产品</th>
					<th>提金数量</th>
					<th>提金克重</th>
					<th>实时金价</th>
					<th>金额</th>
					<th>工费</th>
					<th>总金额</th>
					<th>发票</th>
					<th>创建时间</th>
					<th>提金状态</th>
					<th>操作</th>
				</tr> 
		    </thead>
		    <tbody class="news_content">
		  	  <th:block th:if="${not #lists.isEmpty(page.list)}">
			    	<tr th:each="item:${page.list}">
				    	<td  th:text="${item.code}"></td>
						<td  th:text="${item.userName}"></td>
						<td  th:text="${item.productName}"></td>
						<td  th:text="${item.quantity}"></td>
						<td  th:text="${item.weight}"></td>
						<td  th:text="${item.price}"></td>
						<td  th:text="${item.amount}"></td>
						<td  th:text="${item.labourFeeAmount}"></td>
						<td  th:text="(${item.amount}?${item.amount}:0)
										+(${item.labourFeeAmount}?${item.labourFeeAmount}:0)
										+ (${item.expressFeeAmount}?${item.expressFeeAmount}:0)
										+ (${item.certificateFeeAmount}?${item.certificateFeeAmount}:0)
										+ (${item.insuranceFeeAmount}?${item.insuranceFeeAmount}:0)"></td>
<!-- 						<th:block th:if="${not #strings.isEmpty(item.invoiceCode)}"> -->
<!-- 							<td  th:text="${item.invoiceCode}"></td> -->
<!-- 						</th:block>	 -->
<!-- 						<th:block th:if="${#strings.isEmpty(item.invoiceCode) }"> -->
							<td>已开</td>
<!-- 						</th:block>	 -->
						<td th:text="${#dates.format(item.createTime,'yyyy-MM-dd HH:mm:ss')}"></td>
						<th:block th:switch="${item.status}">
							<td  th:case="0">待审核</td>
							<td  th:case="1">待发货</td>
							<td  th:case="2">付款失败</td>
							<td  th:case="3">已发货</td>
							<td  th:case="4">已签收</td>
							<td  th:case="5">已取消</td>
							<td  th:case="*">未知状态</td>
						</th:block>
						<td>
							<a th:data="${item.id}" class="layui-btn layui-btn-mini physical_view">查看</a>
							<th:block th:if="${item.status eq 1}">
		                        <a th:data="${item.id}" class="layui-btn layui-btn-mini physical_edit physical_logistics" tyle="margin-bottom:10px;">发货</a>
		                    </th:block>
							<th:block th:if="${item.status eq 0}">
		                        <a th:data="${item.id}" th:value="${item.idPic}" class="layui-btn layui-btn-warm layui-btn-mini physical_verify">审核</a>
		                    </th:block>
		                    <th:block th:if="${item.status eq 0 or item.status eq 1}">
		                        <a th:data="${item.id}" class="layui-btn layui-btn-mini physical_edit physical_cancel" tyle="margin-bottom:10px;">取消订单</a>
		                    </th:block>
		                    <th:block th:if="${item.status eq 3 or item.status eq 4}">
		                        <a th:data="${item.id}" class="layui-btn layui-btn-warm layui-btn-mini express_view">查看物流</a>
		                    </th:block>
						</td>
					</tr>
				</th:block>
		    </tbody>
		</table>
	</div>
	<div id="paged" align="right"></div>
	<!--物流信息的弹出层-->
	<div id="orderLogistics" style="display: none;">
		<form class="layui-form">
			<div class="layui-form-item">
				<label class="layui-form-label">快递公司:</label>
				<div class="layui-input-inline">
					<select name="expressCompany" lay-verify="required" lay-search="" data-placeholder="直接选择或搜索选择">
				          <option th:each="vo:${eVo}" th:value="${vo.code}" th:text="${vo.name}">快递公司名称</option>
				    </select>
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">快递单号:</label>
				<div class="layui-input-inline">
					<input type="text" value="" name="expressNo" class="layui-input search_input"/>
				</div>
			</div>
			<div class="layui-form-item" style="margin-top:40px;">
				<input type="hidden" name="id" id="logisticsId">	
				<div class="layui-input-block">
					<div class="layui-layer-btn layui-inline">
						<button class="layui-btn sendReason" lay-submit="" lay-filter="instantSubmitLog" name="type" value="1">提交</button>
					</div>
					<button type="reset" class="layui-btn layui-btn-primary">重置</button>
				</div>
			</div>
		</form>
	</div>
	<!--审核订单时的弹出层-->
	<div id="orderVerify" style="display: none;">
		<form class="layui-form">
			<div class="layui-form-item">
				<label class="layui-form-label">手持身份证图片:</label>
				<div class="layui-input-inline">
					<img src="" style="width: 300px;height: 400px;" id="idPicImg" alt="未上传手持身份证图片">
				</div>
			</div>
			<!-- <div class="layui-form-item">
				<label class="layui-form-label">记得审核呦</label>
				<input type="checkbox" lay-filter="auditResultFilter" id="auditResult" name="auditResult"
                       th:checked="${data}?${data.auditResult == 0}:false" th:value="${data}?${data.auditResult}:'1'"
                       lay-skin="switch" lay-text="通过|拒绝"/>
			</div> -->
			<div class="layui-form-item">
				<label class="layui-form-label">审核说明:</label>
				<div class="layui-input-inline">
					<textarea value="" name="remark" class="layui-input desc" required="required" style="min-height:100px;min-width:300px;" placeholder="请填写审核说明"></textarea>
				</div>
			</div>
			<div class="layui-form-item" style="margin-top:40px;">
				<input type="hidden" name="orderId" id="checkId">	
				<div class="layui-input-block">
					<div class="layui-layer-btn layui-inline">
					  	<button class="layui-btn sendReason" lay-submit="" lay-filter="instantSubmitPass" name="type" value="0">通过</button>
						<button class="layui-btn sendReason" lay-submit="" lay-filter="instantSubmitNg" name="type" value="1">不通过</button>
					</div>
					<button type="reset" class="layui-btn layui-btn-primary">重置</button>
				</div>
			</div>
		</form>
	</div>
	<!--取消订单-->
	<div id="orderCancel" style="display: none;">
		<form class="layui-form">
			<div class="layui-form-item">
				<div class="layui-inline"></div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">取消备注:</label>
				<div class="layui-input-inline">
					<textarea value="" name="remark" placeholder="请填写备注" class="layui-input cancelReason" required="required" style="min-height: 80px;"></textarea>
				</div>
			</div>
			<div class="layui-form-item" style="margin-top: 80px;">
				<input type="hidden" name="orderId" id="cancelId">	
				<div class="layui-input-block">
					<button class="layui-btn sendReason" lay-submit="" lay-filter="instantSubmitCancel">提交</button>
					<button type="reset" class="layui-btn layui-btn-primary">重置</button>
				</div>
			</div>
		</form>
	</div>
	
	<script type="text/javascript" th:src="@{/layui/layui.js}"></script>
	<script type="text/javascript" th:src="@{/jquery/jquery-3.2.1.min.js}"></script>
	</body>
	<script th:inline="javascript">
         layui.use('laypage', function(){
        	  var laypage = layui.laypage;
        	  //执行一个laypage实例
        	  laypage.render({
        	    elem: 'paged', //注意，这里的 test1 是 ID，不用加 # 号
        	    curr: [[${page.pageNum}]],
        	    count: [[${page.total}]], //数据总数，从服务端得到
        	    layout: ['count', 'prev', 'page', 'next'],
                jump: function(obj, first){
                    //得到了当前页，用于向服务端请求对应数据
                    var curr = obj.curr;
                    $("#pageNum").val(curr);
                    if(!first) {
                        $("#searchForm").submit();
					}
                }
        	  });
        	});
        
        layui.use(['layer','form'],function(){
            var layer = layui.layer,$=layui.jquery;
            var form = layui.form;
  			//物流信息
            $(".physical_logistics").bind("click",function() {
                var id = $(this).attr("data");
                $("#logisticsId").val(id);
                layer.open({
                    type: 1,
                    title:"物流信息",
                    content: $('#orderLogistics'), 
                    area: ['399px', '478px'],
                    yes:function(index,layero){
                    	if(!$(".desc").val()) return;
                    }
                });
            });
            //审核
            $(".physical_verify").bind("click",function() {
                var id = $(this).attr("data");
                var idPic = $(this).attr("value");
                $("#checkId").val(id);
                $("#idPicImg").attr("src",idPic);
                layer.open({
                    type: 1,
                    title:"订单审核",
                    content: $('#orderVerify'), 
                    area: ['490px', '520px'],
                    yes:function(index,layero){
                    	if(!$(".desc").val()) return;
                    }
                });
            });
          	//取消
            $(".physical_cancel").bind("click",function() {
                var id = $(this).attr("data");
                var idPic = $(this).attr("value");
                $("#cancelId").val(id);
                layer.open({
                    type: 1,
                    title:"订单取消",
                    content: $('#orderCancel'), 
                    area: ['320px', '560px'],
                    yes:function(index,layero){
                    	if(!$(".desc").val()) return;
                    }
                });
            });

			//查看
			$(".physical_view").bind("click",function(){
			    var id = $(this).attr("data");
				form_html(id,'查看提金订单');
			})
			//物流信息
            form.on('submit(instantSubmitLog)',function(data){
            	  data.field.type = 0;
                  $.post("orderLogistics.html",data.field,function (result) {
                      var jsonData = JSON.parse(result);
                      layer.closeAll();
                      if(jsonData.code>0){
                          layer.alert(jsonData.msg, {
                              title: '操作结果',
                              content: jsonData.msg
                          })
                      } else {
                          setTimeout(function () {
                              layer.open({
                                  title: '操作结果',
                                  content: jsonData.msg,
                                  time:2000
                              });
                              setTimeout(function () {
                                  location.href = "orderList.html"
                              },2000)
                          },500);
                      }
                  })
                  return false;
            });
			  //运营审核-通过
            form.on('submit(instantSubmitPass)',function(data){
            	  data.field.type = 0;
                  $.post("orderAudit.html",data.field,function (result) {
                      var jsonData = JSON.parse(result);
                      layer.closeAll();
                      if(jsonData.code>0){
                          layer.alert(jsonData.msg, {
                              title: '操作结果',
                              content: jsonData.msg
                          })
                      } else {
                          setTimeout(function () {
                              layer.open({
                                  title: '操作结果',
                                  content: jsonData.msg,
                                  time:2000
                              });
                              setTimeout(function () {
                                  location.href = "orderList.html"
                              },2000)
                          },500);
                      }
                  })
                  return false;
            });
			  //运营审核-通过
            form.on('submit(instantSubmitPass)',function(data){
            	  data.field.type = 0;
                  $.post("orderAudit.html",data.field,function (result) {
                      var jsonData = JSON.parse(result);
                      layer.closeAll();
                      if(jsonData.code>0){
                          layer.alert(jsonData.msg, {
                              title: '操作结果',
                              content: jsonData.msg
                          })
                      } else {
                          setTimeout(function () {
                              layer.open({
                                  title: '操作结果',
                                  content: jsonData.msg,
                                  time:2000
                              });
                              setTimeout(function () {
                                  location.href = "orderList.html"
                              },2000)
                          },500);
                      }
                  })
                  return false;
            });
          	//运营审核-不通过
            form.on('submit(instantSubmitNg)',function(data){
            	data.field.type = 1;
                $.post("orderAudit.html",data.field,function (result) {
                    var jsonData = JSON.parse(result);
                    layer.closeAll();
                    if(jsonData.code>0){
                        layer.alert(jsonData.msg, {
                            title: 'Result',
                            content: jsonData.msg
                        })
                    } else {
                        setTimeout(function () {
                            layer.open({
                                title: 'Result',
                                content: jsonData.msg,
                                time:2000
                            });
                            setTimeout(function () {
                                location.href = "orderList.html"
                            },2000)
                        },500);
                    }
                })
                return false;
            });
        	//取消订单
            form.on('submit(instantSubmitCancel)',function(data){
                  $.post("orderCancel.html",data.field,function (result) {
                      var jsonData = JSON.parse(result);
                      layer.closeAll();
                      if(jsonData.code>0){
                          layer.alert(jsonData.msg, {
                              title: '操作结果',
                              content: jsonData.msg
                          })
                      } else {
                          setTimeout(function () {
                              layer.open({
                                  title: '操作结果',
                                  content: jsonData.msg,
                                  time:2000
                              });
                              setTimeout(function () {
                                  location.href = "orderList.html?pageNum="+[[${page.pageNum}]];
                              },2000)
                          },500);
                      }
                  })
                  return false;
            });

			
            function form_html(id,title){
              	$.post('orderDetail.html', {id:id}, function(data){
            	  	layer.open({
            	  	  type: 1,
              		  title: title
              		  ,area: ['600px', '400px']
              		  ,shade: 0
              		  ,content: data
           			  ,yes: function(index, layero){
           				  layer.close(index);
           				}
              		}); 
            	}); 
            };
            
            /**
             * 查看发货物流
             */
            $(".express_view").bind("click",function() {
                var id = $(this).attr("data");
                //Ajax获取
                form_page_html('700px','500px',id,'expressView.html','查看发货物流');
            });
            
             function form_page_html(width,height,id,url,title){
              	$.post(url, {id:id}, function(data){
            	  	layer.open({
            	  	  type: 1,
              		  title: title
              		  ,area: [width,height]
              		  ,shade: 0
              		  ,content: data
           			  ,yes: function(index, layer){
           				  layer.close(index);
           				}
              		}); 
            	}); 
            };
            //导出excel
            $(".excel_btn").bind("click", function () {
                location.href = '/order/info/export/physicalInfo?' + $("#searchForm").serialize();
            });
        });

        layui.use('laydate', function(){
        	var laydate = layui.laydate;
            //执行一个laydate实例
            laydate.render({
                elem: '#startTime' //指定元素
                , type: 'datetime'
                , max: 1
                , format: 'yyyy-MM-dd HH:mm:ss' //可任意组合
            });
            //执行一个laydate实例
            laydate.render({
                elem: '#endTime' //指定元素
                , type: 'datetime'
                , max: 1
                , format: 'yyyy-MM-dd HH:mm:ss' //可任意组合

            });
       	});
        layui.use('form', function(){
             var form = layui.form;
             form.render();
         });
    
	</script>
</html>