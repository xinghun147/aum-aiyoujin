<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>提现订单列表--layui后台管理模板</title>
    <link rel="stylesheet" type="text/css" th:href="@{/layui/css/layui.css}"
          media="all"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/news.css}"
          media="all"/>
    <style>
        .news_search .layui-input-block {
            margin-left: auto;
        }

        .news_search .layui-form-label {
            padding: 9px 10px;
        }
    </style>
</head>
<body class="childrenBody">
<blockquote class="layui-elem-quote news_search">
    <form id="searchForm" name="searchForm" class="layui-form"
          action="orderList.html">
        <input type="hidden" id="pageNum" name="pageNum"
               th:value="${page.pageNum}"/>
        <div class="layui-form-item">
            <label class="layui-form-label">用户:</label>
            <div class="layui-input-inline">
                <input type="text" value="" name="userName"
                       class="layui-input search_input" th:value="${vo.userName}"/>
            </div>
            <label class="layui-form-label">订单编号:</label>
            <div class="layui-input-inline">
                <input type="text" value="" name="code"
                       class="layui-input search_input" th:value="${vo.code}"/>
            </div>
            <label class="layui-form-label">状态:</label>
            <div class="layui-input-inline">
                <select name="status" id="status" lay-filter="statusFilter">
                    <option value="">请选择查询订单状态</option>
                    <option value="0" th:selected="${vo}ne null and ${vo.status == 0}">待运营审核</option>
                    <option value="1" th:selected="${vo}ne null and ${vo.status == 1}">运营审核不通过</option>
                    <option value="2" th:selected="${vo}ne null and ${vo.status == 2}">待财务审核</option>
                    <option value="3" th:selected="${vo}ne null and ${vo.status == 3}">财务审核不通过</option>
                    <option value="4" th:selected="${vo}ne null and ${vo.status == 4}">打款中</option>
                    <option value="5" th:selected="${vo}ne null and ${vo.status == 5}">成功</option>
                    <option value="6" th:selected="${vo}ne null and ${vo.status == 6}">失败</option>
                    <option value="7" th:selected="${vo}ne null and ${vo.status == 7}">取消提现</option>
                </select>
            </div>
             <label class="layui-form-label">创建时间:</label>
			<div class="layui-input-inline">
				<input  type="text" class="layui-input" name="createTime" id="startTime" th:value="${vo.createTime}?${#dates.format(vo.createTime, 'yyyy-MM-dd HH:mm:ss')}"/>
			</div>
			<div class="layui-form-mid">-</div>
			<div class="layui-input-inline">
				<input  type="text" class="layui-input" name="updateTime" id="endTime" th:value="${vo.updateTime}?${#dates.format(vo.updateTime, 'yyyy-MM-dd HH:mm:ss')}"/>
			</div>
            <button class="layui-btn search_btn">
                <i class="layui-icon">&#xe615;</i>查询
            </button>
        </div>
    </form>
</blockquote>
<div class="layui-form news_list">
<div class="demoTable" style="margin-left:58px">
  <button class="layui-btn layui-btn-warm" data-type="getOpCheckData">批量运营审核</button>
  <button class="layui-btn layui-btn-danger" data-type="getFiCheckData" style="margin-left:58px">批量财务审核</button>
</div>
    <table class="layui-table" id='layTable' lay-filter="demo">
        <thead>
        <tr>
         	<th><input type="checkbox" name="" lay-skin="primary" lay-filter="allChoose"></th>  
            <th>用户</th>
            <th>订单编号</th>
            <th>提现金额</th>
            <th>手续费</th>
            <th>提现银行卡</th>
            <th>银行</th>
            <th>状态</th>
            <th>创建时间</th>
            <th>失败原因</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody class="news_content">
        <th:block th:if="${not #lists.isEmpty(page.list)}">
            <tr th:each="item:${page.list}">
                <th><input type="checkbox" name="chk" lay-skin="primary" lay-filter="itemChoose" th:value="${item.id}" th:attr="amount=${item.amount}, status=${item.status}" ></th>  
                <td th:text="${item.userName}"></td>
                <td th:text="${item.code}"></td>
                <td th:text="${item.amount}"></td>
                <td th:text="${item.fee}"></td>
                <td th:text="${item.bankCardNo}"></td>
                <td th:text="${item.bankName}"></td>
                <th:block th:switch="${item.status}">
                    <td th:case="0">待运营审核</td>
                    <td th:case="1">运营审核不通过</td>
                    <td th:case="2">待财务审核</td>
                    <td th:case="3">财务审核不通过</td>
                    <td th:case="4">打款中</td>
                    <td th:case="5">成功</td>
                    <td th:case="6">失败</td>
                    <td th:case="7">取消提现</td>
                    <td th:case="*">未知状态</td>
                </th:block>
                <td th:text="${#dates.format(item.createTime,'yyyy-MM-dd HH:mm:ss')}"></td>
                <td th:text="${item.remark}"></td>
                <td><a th:data="${item.id}"
                       class="layui-btn layui-btn-mini withdraw_view">查看</a>
                    <th:block th:if="${item.status eq 0}">
                        <a th:data="${item.id}" class="layui-btn layui-btn-warm layui-btn-mini withdrawOrder_opCheck">运营审核</a>
                    </th:block>
                    <th:block th:if="${item.status eq 2}">
                        <a th:data="${item.id}" class="layui-btn layui-btn-warm layui-btn-mini withdrawOrder_fiCheck">财务审核</a>
                    </th:block>
                    <th:block th:if="${item.status eq 0}">
                        <a th:data="${item.id}" class="layui-btn layui-btn-danger layui-btn-mini withdraw_del">取消订单</a>
                    </th:block>
                    <th:block th:if="${item.status eq 4}">
                        <a th:data="${item.id}" class="layui-btn layui-btn-danger layui-btn-mini withdraw_del">取消订单</a>
                    </th:block>

                </td>
            </tr>
        </th:block>
        </tbody>
    </table>
</div>
<div id="paged" align="right"></div>
<!--取消订单时的弹出层-->
<div id="orderDel" style="display: none;">
    <form class="layui-form">
        <div class="layui-form-item">
            <div class="layui-inline"></div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">取消原因:</label>
            <div class="layui-input-inline">
					<textarea value="" name="remark" placeholder="请填写取消原因"
                              class="layui-input cancelReason" required="required"
                              style="min-height: 80px;"></textarea>
            </div>
        </div>
        <div class="layui-form-item" style="margin-top: 80px;">
            <input type="hidden" name="orderId" id="cancelId">
            <div class="layui-input-block">
                <button class="layui-btn sendReason" lay-submit=""
                        lay-filter="instantSubmitCancel" name="type" value="0">立即提交
                </button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</div>
<!--审核订单的弹出层-->
<div id="orderCheck" style="display: none;">
    <form class="layui-form">
        <div class="layui-form-item">
            <div class="layui-inline"></div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">审核备注:</label>
            <div class="layui-input-inline">
					<textarea value="" name="remark" placeholder="请填写审核备注"
                              class="layui-input cancelReason" required="required"
                              style="min-height: 80px;"></textarea>
            </div>
        </div>
        <div class="layui-form-item" style="margin-top: 80px;">
            <input type="hidden" name="orderId" id="checkId">
            <div class="layui-input-block">
                <button class="layui-btn sendReason" lay-submit="" lay-filter="instantSubmitPass" name="type" value="0">通过</button>
                <button class="layui-btn sendReason" lay-submit="" lay-filter="instantSubmitNg" name="type" value="1">不通过</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>

            </div>
        </div>
    </form>
</div>
<!--财务审核订单的弹出层-->
<div id="orderCheckFi" style="display: none;">
    <form class="layui-form">
        <div class="layui-form-item">
            <div class="layui-inline"></div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">审核备注:</label>
            <div class="layui-input-inline">
					<textarea value="" name="remark" placeholder="请填写审核备注" class="layui-input cancelReason" required="required" style="min-height: 80px;"></textarea>
            </div>
        </div>
        <div class="layui-form-item" style="margin-top: 80px;">
            <input type="hidden" name="orderId" id="checkIdFi">
            <div class="layui-input-block">
                <button class="layui-btn sendReason" lay-submit="" lay-filter="instantSubmitPassFi" name="type" value="0">通过</button>
                <button class="layui-btn sendReason" lay-submit="" lay-filter="instantSubmitNgFi" name="type" value="1">不通过</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</div>
<script type="text/javascript" th:src="@{/layui/layui.js}"></script>
<script type="text/javascript" th:src="@{/jquery/jquery-3.2.1.min.js}"></script>
</body>
<script th:inline="javascript">
    layui.use('laypage', function () {
        var laypage = layui.laypage;
        //执行一个laypage实例
        laypage.render({
            elem: 'paged', //注意，这里的 test1 是 ID，不用加 # 号
            curr: [[${page.pageNum}]],
            count: [[${page.total}]], //数据总数，从服务端得到
            layout: ['count', 'prev', 'page', 'next'],
            jump: function (obj, first) {
                //得到了当前页，用于向服务端请求对应数据
                var curr = obj.curr;
                $("#pageNum").val(curr);
                if (!first) {
                    $("#searchForm").submit();
                }
            }
        });
    });
   
    layui.use(['layer', 'form'], function () {
        var layer = layui.layer, $ = layui.jquery;
        var form = layui.form;

        //查看
        $(".withdraw_view").bind("click", function () {
            var id = $(this).attr("data");
            form_html(id, '查看提现订单');
        });

        //取消订单
        $(".withdraw_del").bind("click", function () {
            var id = $(this).attr("data");
            $("#cancelId").val(id);
            layer.open({
                type: 1,
                title: "取消订单",
                content: $('#orderDel'), //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
                area: ['400px', '340px']
            });
        });
        //运营审核
        $(".withdrawOrder_opCheck").bind("click", function () {
            var id = $(this).attr("data");
            $("#checkId").val(id);
            layer.open({
                type: 1,
                title: "审核原因",
                content: $('#orderCheck'), //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
                area: ['400px', '340px']
            });
        });
        //财务审核
        $(".withdrawOrder_fiCheck").bind("click", function () {
            var id = $(this).attr("data");
            $("#checkIdFi").val(id);
            layer.open({
                type: 1,
                title: "审核原因",
                content: $('#orderCheckFi'), //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
                area: ['400px', '340px']
            });
        });
        //确定提交取消订单
        $(".sendReason").bind("click", function () {
            if (!$(".cancelReason").val()) return;
        })
        //运营审核-通过
        form.on('submit(instantSubmitPass)', function (data) {
            data.field.type = 0;
            $.post("orderOpCheck.html", data.field, function (result) {
                var jsonData = JSON.parse(result);
                layer.closeAll();
                if (jsonData.code > 0) {
                    layer.alert(jsonData.msg, {
                        title: '处理结果',
                        content: jsonData.msg
                    })
                } else {
                	layer.open({
                        title: '处理结果',
                        content: jsonData.msg,
                        yes: function () {
                        	location.href = "orderList.html";
                        },
	                    cancel: function () {
                        	location.href = "orderList.html";
                        }
                    });
                }
            })
            return false;
        });
        //运营审核-不通过
        form.on('submit(instantSubmitNg)', function (data) {
            data.field.type = 1;
            $.post("orderOpCheck.html", data.field, function (result) {
                var jsonData = JSON.parse(result);
                layer.closeAll();
                if (jsonData.code > 0) {
                    layer.alert(jsonData.msg, {
                        title: '处理结果',
                        content: jsonData.msg
                    })
                } else {
                	layer.open({
                        title: '处理结果',
                        content: jsonData.msg,
                        yes: function () {
                        	location.href = "orderList.html";
                        },
	                    cancel: function () {
                        	location.href = "orderList.html";
                        }
                    });
                }
            })
            return false;
        });
        //财务审核-通过
        form.on('submit(instantSubmitPassFi)', function (data) {
            data.field.type = 0;
            $.post("orderFiCheck.html", data.field, function (result) {
                var jsonData = JSON.parse(result);
                layer.closeAll();
                if (jsonData.code > 0) {
                    layer.alert(jsonData.msg, {
                        title: '处理结果',
                        content: jsonData.msg
                    })
                } else {
                	layer.open({
                        title: '处理结果',
                        content: jsonData.msg,
                        yes: function () {
                        	location.href = "orderList.html";
                        },
	                    cancel: function () {
                        	location.href = "orderList.html";
                        }
                    });
                }
            })
            return false;
        });
        //财务审核-不通过
        form.on('submit(instantSubmitNgFi)', function (data) {
            data.field.type = 1;
            $.post("orderFiCheck.html", data.field, function (result) {
                var jsonData = JSON.parse(result);
                layer.closeAll();
                if (jsonData.code > 0) {
                    layer.alert(jsonData.msg, {
                        title: '处理结果',
                        content: jsonData.msg
                    })
                } else {
                	layer.open({
                        title: '处理结果',
                        content: jsonData.msg,
                        yes: function () {
                        	location.href = "orderList.html";
                        },
	                    cancel: function () {
                        	location.href = "orderList.html";
                        }
                    });
                }
            })
            return false;
        });
        //取消订单
        form.on('submit(instantSubmitCancel)', function (data) {
            $.post("orderCancel.html", data.field, function (result) {
                var jsonData = JSON.parse(result);
                layer.closeAll();
                if (jsonData.code > 0) {
                    layer.alert(jsonData.msg, {
                        title: '处理结果',
                        content: jsonData.msg
                    })
                } else {
                	layer.open({
                        title: '处理结果',
                        content: jsonData.msg,
                        yes: function () {
                        	location.href = "orderList.html";
                        },
	                    cancel: function () {
                        	location.href = "orderList.html";
                        }
                    });
                }
            })
            return false;
        });
        form.on('checkbox(allChoose)', function(data){
            var child = $(data.elem).parents('table').find('tbody input[type="checkbox"]');
            child.each(function(index, item){
                item.checked = data.elem.checked;
            });
            form.render('checkbox');
        });
        form.on('checkbox(itemChoose)',function(data){
            var sib = $(data.elem).parents('table').find('tbody input[type="checkbox"]:checked').length;
            var total = $(data.elem).parents('table').find('tbody input[type="checkbox"]').length;
            if(sib == total){
                $(data.elem).parents('table').find('thead input[type="checkbox"]').prop("checked",true);
                form.render();
            }else{
                $(data.elem).parents('table').find('thead input[type="checkbox"]').prop("checked",false);
                form.render();
            }
        }); 
        form.on('checkbox(chk)',function(data){
           console.log("hhahahhhah==>"+JSON.stringify(data));
        }); 
        function form_html(id, title) {
            $.post('orderDetail.html', {id: id}, function (data) {
                layer.open({
                    type: 1,
                    title: title
                    , area: ['900px', '460px']
                    , shade: 0
                    , content: data
                    , yes: function (index, layero) {
                        layer.close(index);
                    }
                });
            });
        };
    });
    layui.use('laydate', function () {
        var laydate = layui.laydate;
        //执行一个laydate实例
        laydate.render({
            elem: '#startTime' //指定元素
            , type: 'datetime'
            , max: 1
            , format: 'yyyy-MM-dd HH:mm:ss' //可任意组合
        });
        //执行一个laydate实例
        laydate.render({
            elem: '#endTime' //指定元素
            , type: 'datetime'
            , max: 1
            , format: 'yyyy-MM-dd HH:mm:ss' //可任意组合
        });
    });
    layui.use('table', function(){
    	  var table = layui.table;
    	  //监听表格复选框选择
    	  table.on('checkbox(demo)', function(obj){
    	    console.log("checkbox==>"+obj)
    	  });

    	  var $ = layui.$, active = {
    	    getOpCheckData: function(){ //获取选中数据
				var length = $("#layTable").find('tbody input[type="checkbox"]:checked').length;
				var validId = "";
				var validLength = 0;
				var validAmount = 0;
    	    	$("#layTable").find('tbody input[type="checkbox"]:checked').each(function() { // 遍历name=test的多选框
					if($(this).attr("status") == 0){
						validId+=$(this).val()+',';
						validAmount+=parseFloat($(this).attr("amount"));
						++validLength;
					}
    	    	});
    	    	if(validId.length >0){
    	    		validId = validId.substring(0,validId.length-1)	
        	    }
				if(validLength>0){
					var tip = '共选中 [ '+length+' ] 笔,</br>有效处理 [ '+validLength+' ] 笔,</br>有效处理金额 [ '+validAmount+' ] 元.</br>确定批量运营审核吗?';
					 layer.confirm(tip, {
						 	title:'操作提示',
	    	    		    btn: ['全部通过','全部不通过','取消'], //按钮
	    	    		    shade: false //不显示遮罩
	    	    		}, function(index){
			    	    	$.post("orderOpCheckBatch.html", {orderId: validId, type:0}, function (result) {
			    	                var jsonData = JSON.parse(result);
			    	                layer.closeAll();
			    	                if (jsonData.code > 0) {
			    	                    layer.alert(jsonData.msg, {
			    	                        title: '处理结果',
			    	                        content: jsonData.msg
			    	                    })
			    	                } else {
			    	                	layer.open({
		    	                            title: '处理结果',
		    	                            content: jsonData.msg,
		    	                            yes: function () {
		    	                            	location.href = "orderList.html";
			    	                        },
				    	                    cancel: function () {
		    	                            	location.href = "orderList.html";
			    	                        }
		    	                        });
			    	                }
			    	            })
	    	    		    layer.close(index);
	    	    		}, function(index){
			    	    	$.post("orderOpCheckBatch.html", {orderId: validId, type:1}, function (result) {
			    	                var jsonData = JSON.parse(result);
			    	                layer.closeAll();
			    	                if (jsonData.code > 0) {
			    	                    layer.alert(jsonData.msg, {
			    	                        title: '处理结果',
			    	                        content: jsonData.msg
			    	                    })
			    	                } else {
			    	                	layer.open({
		    	                            title: '处理结果',
		    	                            content: jsonData.msg,
		    	                            yes: function () {
		    	                            	location.href = "orderList.html";
			    	                        },
				    	                    cancel: function () {
		    	                            	location.href = "orderList.html";
			    	                        }
		    	                        });
			    	                }
			    	            })
	    	    		    layer.close(index);
	    	    		}

	    	    );
				}else{
					if(length>0){
						layer.alert("请选择需要运营审核的数据");
					}else{
						layer.alert("请选择要操作的数据");
					}
				}
    	    },
    	    getFiCheckData: function(){ //获取选中数据
				var length = $("#layTable").find('tbody input[type="checkbox"]:checked').length;
				var validId = "";
				var validLength = 0;
				var validAmount = 0;
    	    	$("#layTable").find('tbody input[type="checkbox"]:checked').each(function() { // 遍历name=test的多选框
					if($(this).attr("status") == 2){
						validId+=$(this).val()+',';
						validAmount+=parseFloat($(this).attr("amount"));
						++validLength;
					}
    	    	});
    	    	if(validId.length >0){
    	    		validId = validId.substring(0,validId.length-1)	
        	    }
				if(validLength>0){
					var tip = '共选中 [ '+length+' ] 笔,</br>有效处理 [ '+validLength+' ] 笔,</br>有效处理金额 [ '+validAmount+' ] 元.</br>确定批量财务审核吗?';
					 layer.confirm(tip, {
						 	title:'操作提示',
	    	    		    btn: ['全部通过','全部不通过','取消'], //按钮
	    	    		    shade: false //不显示遮罩
	    	    		}, function(index){
			    	    	$.post("orderFiCheckBatch.html", {orderId: validId, type:0}, function (result) {
			    	                var jsonData = JSON.parse(result);
			    	                layer.closeAll();
			    	                if (jsonData.code > 0) {
			    	                    layer.alert(jsonData.msg, {
			    	                        title: '处理结果',
			    	                        content: jsonData.msg
			    	                    })
			    	                } else {
			    	                	layer.open({
		    	                            title: '处理结果',
		    	                            content: jsonData.msg,
		    	                            yes: function () {
		    	                            	location.href = "orderList.html";
			    	                        },
				    	                    cancel: function () {
		    	                            	location.href = "orderList.html";
			    	                        }
		    	                        });
			    	                }
			    	            })
	    	    		    layer.close(index);
	    	    		}, function(index){
			    	    	$.post("orderFiCheckBatch.html", {orderId: validId, type:1}, function (result) {
			    	                var jsonData = JSON.parse(result);
			    	                layer.closeAll();
			    	                if (jsonData.code > 0) {
			    	                    layer.alert(jsonData.msg, {
			    	                        title: '处理结果',
			    	                        content: jsonData.msg
			    	                    })
			    	                } else {
			    	                	layer.open({
		    	                            title: '处理结果',
		    	                            content: jsonData.msg,
		    	                            yes: function () {
		    	                            	location.href = "orderList.html";
			    	                        },
				    	                    cancel: function () {
		    	                            	location.href = "orderList.html";
			    	                        }
		    	                        });
			    	                }
			    	            })
	    	    		    layer.close(index);
	    	    		}

	    	    );
				}else{
					if(length>0){
						layer.alert("请选择需要财务审核的数据");
					}else{
						layer.alert("请选择要操作的数据");
					}
				}
    	    }
    	  };
    	  $('.demoTable .layui-btn').on('click', function(){
    	    var type = $(this).data('type');
    	    active[type] ? active[type].call(this) : '';
    	  });
    }); 
    /* layui.use('form', function () {
        var form = layui.form;
        var option = [[${checkStatus}]];
        console.log(option);
        $('select').val(option);
        form.render();
    }); */
</script>
</html>