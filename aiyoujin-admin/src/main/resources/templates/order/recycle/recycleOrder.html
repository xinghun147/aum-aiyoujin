<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8"/>
	<title>存金订单列表</title>
	<link rel="stylesheet" type="text/css" th:href="@{/layui/css/layui.css}" media="all" />
	<link rel="stylesheet" type="text/css" th:href="@{/css/news.css}" media="all" />
</head>
<body class="childrenBody" style="min-width: 1920px">
	<blockquote class="layui-elem-quote news_search">
	<form id="searchForm" name="searchForm" class="layui-form" action="/recycleOrder/recycleOrder.html">
		<input type="hidden" id="pageNum" name="pageNum" th:value="${page.pageNum}"/>
		  	<div class="layui-form-item">
		  		<label class="layui-form-label">订单编号:</label>
				<div class="layui-input-inline">
					<input  type="text" class="layui-input" name="code" id="code"  th:value="${vo.code}"/>
				</div>
				<label class="layui-form-label">用户名:</label>
				<div class="layui-input-inline">
					<input  type="text" class="layui-input" name="userName" id="code"  th:value="${vo.userName}"/>
				</div>
				<label class="layui-form-label">产品名称:</label>
			  	<div class="layui-input-inline">
				  	<input  type="text" class="layui-input" name="productName" id="code"  th:value="${vo.productName}"/>
			  	</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">产品状态</label>
				<div class="layui-input-inline">
					<select name="status" id="status" lay-filter="statusFilter">
					  	<option value="">请选择查询产品状态</option>
					  	<option value="0" th:selected="${vo.status == 0}">待审核</option>
					  	<option value="1" th:selected="${vo.status == 1}">审核未通过</option>
					  	<option value="2" th:selected="${vo.status == 2}">待取货</option>
					  	<option value="3" th:selected="${vo.status == 3}">物流中</option>
					  	<option value="4" th:selected="${vo.status == 4}">检测中</option>
					 	<option value="5" th:selected="${vo.status == 5}">检测不通过</option>
					 	<option value="6" th:selected="${vo.status == 6}">待用户确认</option>
					 	<option value="7" th:selected="${vo.status == 7}">用户不同意</option>
					 	<option value="8" th:selected="${vo.status == 8}">已完成</option>
					 	<option value="9" th:selected="${vo.status == 9}">已取消</option>
					 	<option value="10" th:selected="${vo.status == 10}">已退货</option>
					</select>
				</div>
			<label class="layui-form-label">创建时间:</label>
            <div class="layui-input-inline">
				<input  type="text" class="layui-input" name="createTime" id="startTime" th:value="${vo.createTime}?${#dates.format(vo.createTime, 'yyyy-MM-dd HH:mm:ss')}" readonly="readonly"/>
			</div>
			<div class="layui-form-mid">-</div>
			<div class="layui-input-inline">
				<input  type="text" class="layui-input" name="updateTime" id="endTime"  th:value="${vo.updateTime}?${#dates.format(vo.updateTime, 'yyyy-MM-dd HH:mm:ss')}" readonly="readonly"/>
			</div>
		    <button class="layui-btn search_btn"><i class="layui-icon">&#xe615;</i>查询</button>
                <a class="layui-btn excel_btn"><i class="layui-icon">&#xe615;</i>导出</a>
            </div>
	</form>
	</blockquote>
	<div class="layui-form news_list">
	  	<table class="layui-table">
		    <thead>
				<tr>
					<th>用户</th>
					<th>订单编号</th>
					<th>产品名称</th>
					<th>存金件数</th>
					<th>存金克重</th>
					<th>实测总毛重</th>
					<th>克重损耗</th>
					<th>实测总净重</th>
					<th>实收金价</th>
					<th>物流费</th>
					<th>保险费</th>
					<th>检测费</th>
					<th>联系人</th>
					<th>联系人电话</th>
					<th>订单状态</th>
					<th>创建时间</th>
					<th>操作</th>
				</tr> 
		    </thead>
		    <tbody class="news_content">
		  	  <th:block th:if="${not #lists.isEmpty(page.list)}">
			    	<tr th:each="item:${page.list}">
			    	    <td  th:text="${item.userName}" ></td>
				    	<td  th:text="${item.code}"></td>
						<td  th:text="${item.productName}"></td>
						<td  th:text="${item.applyQuantity}"></td>
						<td  th:text="${item.applyWeight}"></td>
						<td  th:text="${item.realGrossWeight}"></td>
						<td  th:text="${item.realLoss}"></td>
						<td  th:text="${item.realNetWeight}"></td>
						<td  th:text="${item.realPrice}"></td>
						<td  th:text="${item.expressFee}"></td>
						<td  th:text="${item.insuranceFee}"></td>
						<td  th:text="${item.verifyFee}"></td>
						<td  th:text="${item.contact}"></td>
						<td  th:text="${item.telephone}"></td>
						<th:block th:switch="${item.status}">
						    <td  th:case="0">待审核</td>
							<td  th:case="1">审核未通过</td>
							<td  th:case="2">待取货</td>
							<td  th:case="3">物流中</td>
							<td  th:case="4">检测中</td>
							<td  th:case="5">检测不通过</td>
							<td  th:case="6">待用户确认</td>
							<td  th:case="7">用户不同意</td>
							<td  th:case="8">已完成</td>
							<td  th:case="9">已取消</td>
							<td  th:case="10">已退货</td>
							<td  th:case="*">未知状态</td>
						</th:block>
						<td th:text="${#dates.format(item.createTime,'yyyy-MM-dd HH:mm:ss')}"></td>
				    	<td>
				    		<a th:data="${item.id}" class="layui-btn layui-btn-mini recycle_product_view">查看</a>
							<th:block th:switch="${item.status}">
								<a th:case="0" th:data="${item.id}" class="layui-btn layui-btn-mini recycle_order_audit">预约审核</a>
								<a th:case="2" th:data="${item.id}" class="layui-btn layui-btn-mini recycle_order_dtd">取货确认</a>
								<a th:case="3" th:data="${item.id}" class="layui-btn layui-btn-mini recycle_order_receive">收货确认</a>
								<a th:case="4" th:data="${item.id}" class="layui-btn layui-btn-mini recycle_order_verify">上传检测报告</a>
							</th:block>
 					    		<th:block th:if ="${item.status eq 5 or item.status eq 7}">
									<a th:data="${item.id}" class="layui-btn layui-btn-mini recycle_order_return">退货</a>
								</th:block>
 					    		<th:block th:if ="${item.status eq 3}">
									<a th:data="${item.id}" th:attr="company=${item.expressCompany}, no=${item.expressNo}" class="layui-btn layui-btn-mini recycle_order_express">查看/更新取货物流</a>
								</th:block>
 					    		<th:block th:if ="${item.status eq 10}">
									<a th:data="${item.id}" th:attr="company=${item.expressCompanyReturn}, no=${item.expressNoReturn}" class="layui-btn layui-btn-mini recycle_order_express">查看/更新退货物流</a>
								</th:block>
								<th:block th:if ="${item.status eq 0 or item.status eq 2}">
									<a th:data="${item.id}" class="layui-btn layui-btn-mini recycle_order_cancel">取消订单</a>
								</th:block>
								<th:block th:if ="${item.status eq 4 or item.status eq 5 or item.status eq 6 or item.status eq 7 or item.status eq 8 or item.status eq 10}">
									<a th:data="${item.id}" th:attr="company=${item.expressCompany}, no=${item.expressNo}" class="layui-btn layui-btn-mini express_receive_view">取货物流详情</a>
								</th:block>
								<th:block th:if ="${item.status eq 10}">
									<a th:data="${item.id}" th:attr="company=${item.expressCompanyReturn}, no=${item.expressNoReturn}" class="layui-btn layui-btn-mini express_return_view">退货物流详情</a>
								</th:block>
						</td>
					</tr>
				</th:block>
		    </tbody>
		</table>
	</div>
	<div id="paged" align="right"></div>
	<!--审核订单的弹出层-->
	<div id="orderCheck" style="display: none;">
		<form class="layui-form">
			<div class="layui-form-item">
				<div class="layui-inline"></div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">审核备注:</label>
				<div class="layui-input-inline">
					<textarea value="" name="remark" placeholder="请填写审核备注"
						class="layui-input cancelReason" required="required"
						style="min-height: 80px;"></textarea>
				</div>
			</div>
			<div class="layui-form-item" style="margin-top: 80px;">
				<input type="hidden" name="id" id="checkId">	
				<div class="layui-input-block">
					<button class="layui-btn sendReason" lay-submit="" lay-filter="instantSubmitCheckPass" name="type" value="0">通过</button>
					<button class="layui-btn sendReason" lay-submit="" lay-filter="instantSubmitCheckNg" name="type" value="1">不通过</button>
					<button type="reset" class="layui-btn layui-btn-primary">重置</button>
				</div>
			</div>
		</form>
	</div>
	<!-- 取货确认订单的弹出层-->
	 <div id="orderDtd" style="display: none;">
		<form class="layui-form">
			<div class="layui-form-item">
				<label class="layui-form-label">快递公司:</label>
				<div class="layui-input-inline">
					<select name="expressCompany" lay-verify="required" lay-search="" data-placeholder="直接选择或搜索选择" id="selectDtd">
				          <option th:each="vo:${eVo}" th:value="${vo.code}" th:text="${vo.name}">快递公司名称</option>
				    </select>
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">快递单号:</label>
				<div class="layui-input-inline">
					<input type="text" value="" name="expressNo" class="layui-input search_input"/>
				</div>
			</div>
			<div class="layui-form-item" style="margin-top:40px;">
				<input type="hidden" name="id" id="dtdId">	
				<div class="layui-input-block">
					<div class="layui-layer-btn layui-inline">
						<button class="layui-btn sendReason" lay-submit="" lay-filter="instantSubmitDtd" name="type" >提交</button>
					</div>
					<button type="reset" class="layui-btn layui-btn-primary">重置</button>
				</div>
			</div>
		</form>
	</div>
	<!-- 更新物流信息-->
	<div id="orderExpress" style="display: none;">
		<form class="layui-form">
			<div class="layui-form-item">
				<label class="layui-form-label">快递公司:</label>
				<div class="layui-input-inline">
					<select name="expressCompany" lay-verify="required" lay-search="" data-placeholder="直接选择或搜索选择" id="expressUpdate">
				          <!-- <option th:each="vo:${eVo}" th:value="${vo.code}" th:text="${vo.name}">快递公司名称</option> -->
				    </select>
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">快递单号:</label>
				<div class="layui-input-inline">
					<input type="text" value="" id="expressNo" name="expressNo" class="layui-input search_input"/>
				</div>
			</div>
			<div class="layui-form-item" style="margin-top:40px;">
				<input type="hidden" name="id" id="expressId">	
				<div class="layui-input-block">
					<div class="layui-layer-btn layui-inline">
						<button class="layui-btn sendReason" lay-submit="" lay-filter="instantSubmitExpress" name="type" >提交</button>
					</div>
					<button type="reset" class="layui-btn layui-btn-primary">重置</button>
				</div>
			</div>
		</form>
	</div>
	<!--退货的弹出层-->
	<div id="orderReturn" style="display: none;">
		<form class="layui-form">
			<div class="layui-form-item">
				<label class="layui-form-label">快递公司:</label>
				<div class="layui-input-inline">
					<select name="expressCompanyReturn" lay-verify="required" lay-search="" data-placeholder="直接选择或搜索选择" id="selectReturn">
				         <!--  <option th:each="vo:${eVo}" th:value="${vo.code}" th:text="${vo.name}">快递公司名称</option> -->
				    </select>
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">快递单号:</label>
				<div class="layui-input-inline">
					<input type="text" value="" name="expressNoReturn" class="layui-input search_input"/>
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">备注:</label>
				<div class="layui-input-inline">
					<textarea value="" name="returnRemark" placeholder="请填写备注"
						class="layui-input cancelReason" required="required"
						style="min-height: 80px;"></textarea>
				</div>
			</div>
			<div class="layui-form-item" style="margin-top:40px;">
				<input type="hidden" name="id" id="returnId">	
				<div class="layui-input-block">
					<div class="layui-layer-btn layui-inline">
						<button class="layui-btn sendReason" lay-submit="" lay-filter="instantSubmitReturn">提交</button>
					</div>
					<button type="reset" class="layui-btn layui-btn-primary">重置</button>
				</div>
			</div>
		</form>
	</div>
	<!--取消的弹出层-->
	<div id="orderCancel" style="display: none;">
		<form class="layui-form">
			<div class="layui-form-item">
				<div class="layui-inline"></div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">取消备注:</label>
				<div class="layui-input-inline">
					<textarea value="" name="cancelRemark" placeholder="请填写备注"
						class="layui-input cancelReason" required="required"
						style="min-height: 80px;"></textarea>
				</div>
			</div>
			<div class="layui-form-item" style="margin-top: 80px;">
				<input type="hidden" name="id" id="cancelId">	
				<div class="layui-input-block">
					<button class="layui-btn sendReason" lay-submit="" lay-filter="instantSubmitCancel">提交</button>
					<button type="reset" class="layui-btn layui-btn-primary">重置</button>
				</div>
			</div>
		</form>
	</div>
	<script type="text/javascript" th:src="@{/layui/layui.js}"></script>
    <script type="text/javascript" th:src="@{/jquery/jquery-3.2.1.min.js}"></script>
	</body>
	<script th:inline="javascript">
         layui.use('laypage', function(){
        	  var laypage = layui.laypage;
        	  //执行一个laypage实例
        	  laypage.render({
        	    elem: 'paged', //注意，这里的 test1 是 ID，不用加 # 号
        	    curr: [[${page.pageNum}]],
        	    count: [[${page.total}]], //数据总数，从服务端得到
        	    layout: ['count', 'prev', 'page', 'next'],
                jump: function(obj, first){
                    //得到了当前页，用于向服务端请求对应数据
                    var curr = obj.curr;
                    $("#pageNum").val(curr);
                    if(!first) {
                        $("#searchForm").submit();
					}
                }
        	  });
        	});
        
        layui.use(['layer','form'], function(){
            var layer = layui.layer,$=layui.jquery;
            var form = layui.form;
			 //物流-确认取货
			$(".recycle_order_dtd").bind("click",function() {
				var id = $(this).attr("data");
				$("#dtdId").val(id);
				 $.post("expressSelect.html",{id:id},function (result) {
                     var jsonData = JSON.parse(result);
                     $("#selectDtd").append(jsonData.msg);
                     form.render('select') 
                 })
                 layer.open({
                     type: 1,
                     title:"取货确认",
                     content: $('#orderDtd'), 
                     area: ['400px', '340px']
                 });
			});

			//确认收货
			$(".recycle_order_receive").bind("click",function() {
				var id = $(this).attr("data");
				var a = confirm("确认收到货了吗?");
				if(a==1){
					 $.post("orderReceive.html",{id:id},function (result) {
	                      var jsonData = JSON.parse(result);
	                      layer.closeAll();
	                      if(jsonData.code>0){
	                          layer.alert(jsonData.msg, {
	                              title: '操作结果',
	                              content: jsonData.msg
	                          })
	                      } else {
	                          setTimeout(function () {
	                              layer.open({
	                                  title: '操作结果',
	                                  content: jsonData.msg,
	                                  time:2000
	                              });
	                              setTimeout(function () {
	                                  location.href = "recycleOrder.html?pageNum="+[[${page.pageNum}]];
	                              },2000)
	                          },500);
	                      }
	                  })
	                  return false;
				}
			});
			//更新物流信息
			$(".recycle_order_express").bind("click",function() {
				var id = $(this).attr("data");
				var company = $(this).attr("company");
				var no = $(this).attr("no");
				$("#expressId").val(id);
				$("#expressCompany").val(company);
				$("#expressNo").val(no);
				$.post("expressSelect.html",{id:id,expressCompany:company},function (result) {
                    var jsonData = JSON.parse(result);
                    $("#expressUpdate").append(jsonData.msg);
                    form.render('select') 
                })
				
				layer.open({
                    type: 1,
                    title:"上传/更新物流信息",
                    content: $('#orderExpress'), 
                    area: ['400px', '340px']
                });
			});

			 //退货
			$(".recycle_order_return").bind("click",function() {
				var id = $(this).attr("data");
				$("#returnId").val(id);
				 $.post("expressSelect.html",{id:id},function (result) {
                     var jsonData = JSON.parse(result);
                     $("#selectReturn").append(jsonData.msg);
                     form.render('select') 
                 })
				layer.open({
                    type: 1,
                    title:"退货",
                    content: $('#orderReturn'), 
                    area: ['500px', '450px']
                });
			}); 
			//取消订单
			$(".recycle_order_cancel").bind("click",function() {
				var id = $(this).attr("data");
				$("#cancelId").val(id);
				layer.open({
                    type: 1,
                    title:"订单取消",
                    content: $('#orderCancel'), 
                    area: ['400px', '340px']
                });
			});
			//取货确认
            form.on('submit(instantSubmitDtd)',function(data){
                  $.post("orderDtd.html",data.field,function (result) {
                      var jsonData = JSON.parse(result);
                      layer.closeAll();
                      if(jsonData.code>0){
                          layer.alert(jsonData.msg, {
                              title: '操作结果',
                              content: jsonData.msg
                          })
                      } else {
                          setTimeout(function () {
                              layer.open({
                                  title: '操作结果',
                                  content: jsonData.msg,
                                  time:2000
                              });
                              setTimeout(function () {
                                  location.href = "recycleOrder.html?pageNum="+[[${page.pageNum}]];
                              },2000)
                          },500);
                      }
                  })
                  return false;
            }); 
			// 更新物流信息
            form.on('submit(instantSubmitExpress)',function(data){
                  $.post("orderExpress.html",data.field,function (result) {
                      var jsonData = JSON.parse(result);
                      layer.closeAll();
                      if(jsonData.code>0){
                          layer.alert(jsonData.msg, {
                              title: '操作结果',
                              content: jsonData.msg
                          })
                      } else {
                          setTimeout(function () {
                              layer.open({
                                  title: '操作结果',
                                  content: jsonData.msg,
                                  time:2000
                              });
                              setTimeout(function () {
                                  location.href = "recycleOrder.html?pageNum="+[[${page.pageNum}]];
                              },2000)
                          },500);
                      }
                  })
                  return false;
            });
         	//退货
            form.on('submit(instantSubmitReturn)',function(data){
                  $.post("orderReturn.html",data.field,function (result) {
                      var jsonData = JSON.parse(result);
                      layer.closeAll();
                      if(jsonData.code>0){
                          layer.alert(jsonData.msg, {
                              title: '操作结果',
                              content: jsonData.msg
                          })
                      } else {
                          setTimeout(function () {
                              layer.open({
                                  title: '操作结果',
                                  content: jsonData.msg,
                                  time:2000
                              });
                              setTimeout(function () {
                            	  location.href = "recycleOrder.html?pageNum="+[[${page.pageNum}]];
                              },2000)
                          },500);
                      }
                  })
                  return false;
            });
          	//取消订单
            form.on('submit(instantSubmitCancel)',function(data){
                  $.post("orderCancel.html",data.field,function (result) {
                      var jsonData = JSON.parse(result);
                      layer.closeAll();
                      if(jsonData.code>0){
                          layer.alert(jsonData.msg, {
                              title: '操作结果',
                              content: jsonData.msg
                          })
                      } else {
                          setTimeout(function () {
                              layer.open({
                                  title: '操作结果',
                                  content: jsonData.msg,
                                  time:2000
                              });
                              setTimeout(function () {
                                  location.href = "recycleOrder.html?pageNum="+[[${page.pageNum}]];
                              },2000)
                          },500);
                      }
                  })
                  return false;
            });
            
            //审核-通过
            form.on('submit(instantSubmitCheckPass)',function(data){
            	  data.field.type = 0;
                  $.post("orderOpCheck.html",data.field,function (result) {
                      var jsonData = JSON.parse(result);
                      layer.closeAll();
                      if(jsonData.code>0){
                          layer.alert(jsonData.msg, {
                              title: '操作结果',
                              content: jsonData.msg
                          })
                      } else {
                          setTimeout(function () {
                              layer.open({
                                  title: '操作结果',
                                  content: jsonData.msg,
                                  time:2000
                              });
                              setTimeout(function () {
                                  location.href = "recycleOrder.html?pageNum="+[[${page.pageNum}]];
                              },2000)
                          },500);
                      }
                  })
                  return false;
            });
            //审核-不通过
            form.on('submit(instantSubmitCheckPass)',function(data){
            	  data.field.type = 0;
                  $.post("orderOpCheck.html",data.field,function (result) {
                      var jsonData = JSON.parse(result);
                      layer.closeAll();
                      if(jsonData.code>0){
                          layer.alert(jsonData.msg, {
                              title: '操作结果',
                              content: jsonData.msg
                          })
                      } else {
                          setTimeout(function () {
                              layer.open({
                                  title: '操作结果',
                                  content: jsonData.msg,
                                  time:2000
                              });
                              setTimeout(function () {
                                  location.href = "recycleOrder.html?pageNum="+[[${page.pageNum}]];
                              },2000)
                          },500);
                      }
                  })
                  return false;
            });

            //编辑
            $(".recycle_product_view").bind("click",function() {
                var id = $(this).attr("data");
                //Ajax获取
            	form_html('700px','500px',id,'recycleOrderEdit.html','查看存金订单');
            });

            /**
			 * 审核
             */
            $(".recycle_order_audit").bind("click",function() {
                var id = $(this).attr("data");
            	//Ajax获取
            	form_html('700px','500px',id,'recycleOrderAudit.html','审核存金订单');
            });

            /**
             * 检测
             */
            $(".recycle_order_verify").bind("click",function() {
                var id = $(this).attr("data");
                //Ajax获取
                form_html('700px','500px',id,'recycleOrderVerify.html','检测存金实物');
            });

            /**
             * 查看取货物流
             */
            $(".express_receive_view").bind("click",function() {
                var id = $(this).attr("data");
                //Ajax获取
                form_html('700px','500px',id,'expressReceiveView.html','查看取货物流');
            });
            /**
             * 查看退货物流
             */
            $(".express_return_view").bind("click",function() {
                var id = $(this).attr("data");
                //Ajax获取
                form_html('700px','500px',id,'expressReturnView.html','查看退货物流');
            });
            
             function form_html(width,height,id,url,title){
              	$.post(url, {id:id}, function(data){
            	  	layer.open({
            	  	  type: 1,
              		  title: title
              		  ,area: [width,height]
              		  ,shade: 0
              		  ,content: data
           			  ,yes: function(index, layer){
           				  layer.close(index);
           				}
              		}); 
            	}); 
            };
            //导出excel
            $(".excel_btn").bind("click", function () {
                location.href = '/report/recycleOrderExcel?' + $("#searchForm").serialize();
            });
        });
        
        layui.use('laydate', function () {
            var laydate = layui.laydate;
            //执行一个laydate实例
            laydate.render({
                elem: '#startTime' //指定元素
                , type: 'datetime'
                , max: 1
                , format: 'yyyy-MM-dd HH:mm:ss' //可任意组合
            });
            //执行一个laydate实例
            laydate.render({
                elem: '#endTime' //指定元素
                , type: 'datetime'
                , max: 1    
                , format: 'yyyy-MM-dd HH:mm:ss' //可任意组合
            });
        });

	</script>
</html>